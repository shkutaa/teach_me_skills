(function($,window,document,undefined){$.reviewManager=function(selector){var self=this;var options={reviewSelector:'.rm-review',headerCountSelector:'.rm-review-header-count',formSelector:'.rm-review-form',formBlockSelector:'.rm-review-form-block',formEditBlockSelector:'.rm-review-form-edit-block',formEditLinkCancelSelector:'.rm-review-form-edit-link-cancel',formCreateLinkCancelSelector:'.rm-review-form-create-link-cancel',reviewListSelector:'.rm-review-list',reviewMainListSelector:'.rm-review-main-list',reviewMainListDelayedSelector:'.rm-review-main-list-delayed',reviewMoreLinkSelector:'.rm-review-more-link',reviewMoreLinkBlockSelector:'.rm-review-more-link-block',reviewFormVoteSelector:'.rm-review-form-mark',reviewVoteBlockSelector:'.rm-review-vote-block',reviewRatingBlockSelector:'.rm-review-rating-block',reviewSendVoteSelector:'.rm-review-send-vote',errorBlockSelector:'.rm-error-block',errorActionsBlockSelector:'.rm-actions-error-block',errorTextSelector:'.rm-error-text',errorDisabledTabSelector:'#errorDisabledTab',errorTimer:null,repliesButtonSelector:'.rm-review-expander',answerButtonSelector:'.rm-review-answer',editButtonSelector:'.rm-review-edit',deleteButtonSelector:'.rm-review-delete',restoreButtonSelector:'.rm-review-restore',classCommentsProcessing:'b-comments_processing',classReviewReplies:'b-comment_show-replies',classReviewAnswer:'b-comment_expanded',classReviewEdit:'b-comment_editing',classReplyEdit:'b-comment-reply_editing',classReviewNew:'b-comment_new',classMoreLinkProcessing:'b-comments__control_processing',classButtonProcessing:'i-button_processing',classReviewControlsItem:'b-comment-controls__item',classFormShaking:'b-comment-new_shaking',classFormVoteChecked:'b-comment-new__rating-star_checked',classVoteBlockProcessing:'b-comment-likes_processing',classVoteBlockSuccess:'b-comment-likes_success',classVoteMadeTransition:'b-comment-new__rating-stars_anim',classVoteNegative:'i-button_counter_minus',classVoteZero:'i-button_counter_zero',classVoteNewLike:'b-comment-likes_new-like',classRatingBlockHidden:'b-comment-likes__counter_hidden',classErrorShow:'i-popover_visible',classHeaderMuted:'b-comments__title_muted',};var eventCommentsLoaded=new Event('comments:loaded')
var _manager=$(selector);var $form=$('.b-comment-new').last();var $textarea=$form.find('textarea');var $checkbox=$form.find('.i-checkbox__real');var $document=$(document);if(_manager.length==1){_manager=_manager.eq(0);}else{console.log('Invalid reviewManager selector')||0;}
autosize(_manager.find('textarea'));checkAnswerReview();checkAnchor();if($(_manager).find(options.reviewMainListSelector).is(options.reviewMainListDelayedSelector)){var query=window.location.search.toString();var fullExpand=query.indexOf('filter')!=-1||query.indexOf('rvc_comment_edit')!=-1;var _data={reviewManager:1,ajax:1,action:'moreReview',fullExpand:fullExpand?1:0,showDelayed:1}
$.ajax({url:_manager.find(options.formSelector).attr('action'),data:_data,method:'post',dataType:"json",success:function(data,status,xhr){if(data.success&&data.html){_manager.find(options.reviewMainListSelector).append(data.html);_manager.find(options.reviewMoreLinkBlockSelector).hide();autosize(_manager.find('textarea'));checkAnswerReview();if(data.more){_manager.find(options.reviewMoreLinkBlockSelector).removeClass(options.classMoreLinkProcessing).find(options.reviewMoreLinkSelector).html(data.more+'<span class="b-comments__spinner"></span>');_manager.find(options.reviewMoreLinkBlockSelector).show();}
if(window.location.hash&&$(window.location.hash).length){$('html, body').animate({scrollTop:$(window.location.hash).offset().top},50);}
checkAnchor();checkRAF();document.dispatchEvent(eventCommentsLoaded)}else{}}});}else{checkRAF();}
$textarea.on('focus.textareaFocus',function(e){$form.addClass('b-comment-new_focus');$document.on('click.textareaBlur',function(e){if(!$(e.target).parents('.b-comment-new').length){if(!$checkbox.prop('checked')){$document.off('click.textareaBlur');$form.removeClass('b-comment-new_focus');}}});});$(_manager).on('click.rm',options.reviewMoreLinkSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);_manager.find(options.reviewMoreLinkBlockSelector).addClass(options.classMoreLinkProcessing);var _data={reviewManager:1,ajax:1,action:'moreReview'}
$.ajax({url:_manager.find(options.formSelector).attr('action'),data:_data,method:'post',dataType:"json",success:function(data,status,xhr){if(data.success&&data.html){_manager.find(options.reviewMainListSelector).append(data.html);_manager.find(options.reviewMoreLinkBlockSelector).hide();autosize(_manager.find('textarea'));document.dispatchEvent(eventCommentsLoaded)}else{}}});});$(_manager).on('click.rm',options.repliesButtonSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);$this.closest(options.reviewSelector).toggleClass(options.classReviewReplies);});$(_manager).on('click.rm',options.answerButtonSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);var _data={reviewManager:1,ajax:1,type:'answer',action:'checkAuth'}
if(!$this.closest(options.reviewSelector).hasClass(options.classReviewAnswer)){$this.addClass('i-button_processing');}
$.ajax({url:$this.attr('action'),data:_data,method:'post',dataType:"json",complete:function(){$this.removeClass('i-button_processing');},success:function(data,status,xhr){if(data.error=='0'){var _review=$this.closest(options.reviewSelector).toggleClass(options.classReviewAnswer);if(_review.hasClass(options.classReviewAnswer)){try{var _txt=_review.find(options.formBlockSelector).eq(0).find('TEXTAREA').focus();setTimeout(function(){_review.find(options.formBlockSelector).eq(0).find('TEXTAREA').focus();},0);autosize.update(_txt);}catch(ex){}}else{var _topReview=$this.closest(options.reviewSelector);_topReview.find(options.formSelector+' textarea.b-comment-new__textarea').val('');}}else{var _topReview=$this.closest(options.reviewSelector);showActionError(_topReview,data.errorMessage);}}});});$(_manager).on('click.rm',options.formEditLinkCancelSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);var _topReview=$this.closest(options.reviewSelector);var _form=_topReview.find(options.formEditBlockSelector).eq(0);_form.html('').hide();_topReview.removeClass(options.classReviewEdit).removeClass(options.classReplyEdit);});$(_manager).on('click.rm',options.formCreateLinkCancelSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);var _topReview=$this.closest(options.reviewSelector);_topReview.removeClass(options.classReviewAnswer);_topReview.find(options.formSelector+' textarea.b-comment-new__textarea').val('');});$(_manager).on('click.rm',options.editButtonSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);var _topReview=$this.closest(options.reviewSelector);var _form=_topReview.find(options.formEditBlockSelector).eq(0);if(_form.html()!==''&&_form.is(':visible')){_form.html('').hide();return;}
$this.addClass(options.classButtonProcessing);var _data={reviewManager:1,ajax:1,idReview:_topReview.data('reviewId'),level:_topReview.data('reviewLevel'),type:'edit',action:'editReview'}
$.ajax({url:_topReview.find(options.formSelector).attr('action'),data:_data,method:'post',dataType:"json",complete:function(data,status,xhr){$this.removeClass(options.classButtonProcessing);},success:function(data,status,xhr){if(data.success&&data.html){_topReview.removeClass(options.classReviewAnswer);try{if(data.level==1){_topReview.addClass(options.classReplyEdit);}else{_topReview.addClass(options.classReviewEdit);}
_form.html(data.html).show().find('TEXTAREA').caretToEnd();document.dispatchEvent(eventCommentsLoaded)}catch(ex){}
autosize(_form.find('textarea'));}else{showActionError(_topReview,data.errorMessage);}}});});$(_manager).on('click.rm',options.deleteButtonSelector,function(e){e.preventDefault();e.stopImmediatePropagation();processDeleteRestoreReview($(this),'delete');});$(_manager).on('click.rm',options.restoreButtonSelector,function(e){e.preventDefault();e.stopImmediatePropagation();processDeleteRestoreReview($(this),'restore');});$(_manager).on('keyup.rm',options.formSelector+' TEXTAREA',function(e){if(e.which==13&&e.ctrlKey){$(this).closest('FORM').submit();e.preventDefault();}});$(_manager).on('click.rm',options.reviewFormVoteSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);$this.closest('FORM').find('input[name=mark]').val($this.data('mark'));$this.parent().find(options.reviewFormVoteSelector).removeClass(options.classFormVoteChecked);$this.addClass(options.classFormVoteChecked);if(!$('html').hasClass('mobile-yes')){$this.parent().addClass(options.classVoteMadeTransition);setTimeout(function(){$this.parent().removeClass(options.classVoteMadeTransition);},1200);}});$(_manager).on('click.rm',options.reviewSendVoteSelector,function(e){e.preventDefault();e.stopImmediatePropagation();var $this=$(this);var _idReview=$this.closest(options.reviewSelector).data('reviewId');$this.closest(options.reviewVoteBlockSelector).addClass(options.classVoteBlockProcessing);var _topReview=$this.closest(options.reviewSelector);var _data={reviewManager:1,ajax:1,idReview:_idReview,level:0,type:'saveVote',action:'saveVote'}
$.ajax({url:$this.attr('action'),data:_data,method:'post',dataType:"json",complete:function(data,status,xhr){$this.closest(options.reviewVoteBlockSelector).removeClass(options.classVoteBlockProcessing);},success:function(data,status,xhr){if(data.success){$this.closest(options.reviewVoteBlockSelector).addClass(options.classVoteBlockSuccess);_topReview.find(options.reviewRatingBlockSelector).html(data.rating>0?'+'+data.rating:(data.rating<0?'&minus;'+Math.abs(data.rating):data.rating)).removeClass(options.classRatingBlockHidden);if(data.rating==0){_topReview.find(options.reviewRatingBlockSelector).removeClass(options.classVoteNegative);_topReview.find(options.reviewRatingBlockSelector).addClass(options.classVoteZero);}
$this.closest(options.reviewVoteBlockSelector).addClass(options.classVoteNewLike);}else{showActionError(_topReview,data.errorMessage);}}});});$(_manager).on('submit.rm',options.formSelector,function(e){e.preventDefault();var $this=$(this);try{$this.find(options.errorBlockSelector).removeClass(options.classErrorShow);}catch(err){}
if($.trim($this.find('TEXTAREA[name=message]').val())==''){$this.closest('.b-comment-new').addClass(options.classFormShaking);$this.find('TEXTAREA').focus();setTimeout(function(){$this.closest('.b-comment-new').removeClass(options.classFormShaking);},1000);return;}
var $bComments=$this.closest('.b-comments');if($bComments.hasClass('b-comments_empty')){$bComments.addClass('b-comments_hidden');}
var _data=$this.serialize();$this.find('BUTTON').addClass(options.classButtonProcessing);var _topReview=$this.closest(options.reviewSelector);$.ajax({url:$this.attr('action'),data:_data,method:'post',dataType:"json",timeout:5000,complete:function(data,status,xhr){$this.find('BUTTON').removeClass(options.classButtonProcessing);$bComments.removeClass('b-comments_hidden');},error:function(data,status,xhr){try{$this.find('TEXTAREA').focus();$this.find(options.errorBlockSelector).addClass(options.classErrorShow).find(options.errorTextSelector).html('Произошла ошибка при сохранении сообщения, попробуйте еще раз');}catch(err){}},success:function(data,status,xhr){if(data.success&&data.html){var _txt=$this.find('TEXTAREA').val('');setTimeout(function(){autosize.update(_txt);},10);if(data.mode=='create'){var _newReview=$(data.html);var isCommentCreated=false;if(!_topReview.length){_list=_manager.find(options.reviewListSelector).eq(0);if($bComments.hasClass('b-comments_one')){$bComments.removeClass('b-comments_one');}
if($bComments.hasClass('b-comments_empty')){$bComments.addClass('b-comments_one');$bComments.addClass('b-comments_visible');$bComments.removeClass('b-comments_empty');}}else{_list=_topReview.find(options.reviewListSelector);_topReview.addClass(options.classReviewReplies);isCommentCreated=true;}
if(data.countText){_manager.find(options.headerCountSelector).html(data.countText).removeClass(options.classHeaderMuted);}
if(data.countParentText&&_topReview.length){_topReview.find(options.repliesButtonSelector).html(data.countParentText).parent().show().addClass(options.classReviewControlsItem);$this.closest(options.reviewSelector).removeClass(options.classReviewAnswer);}
_list.append(_newReview);if(data.statistics){$('.b-comments__col.b-comments__col_left').html(data.statistics);}
if(isCommentCreated){setTimeout(function(){var _padTop=parseInt(_newReview.css('paddingTop'));$('html, body').animate({scrollTop:$(_newReview).offset().top-15+_padTop},250,function(){_newReview.addClass(options.classReviewNew);setTimeout(function(){_newReview.removeClass(options.classReviewNew);},1000);});},150);}else{var fakeOrderEl=$('<div class="reviewsDateDesc"></div>');var fakeStatfilterEl=$('<div data-statfilter="all"></div>');var $sortReviewDesc=$('.reviewsDateDesc');if($('html').hasClass('mobile-yes')){$sortReviewDesc.closest('.b-comments-stat__action-filter').find('.b-comments-stat__filter-item').removeClass('b-comments-stat__filter-item_active');$sortReviewDesc.closest('.b-comments-stat__filter-item').addClass('b-comments-stat__filter-item_active');}else{$('.b-comments__tabs-link').removeClass('b-comments__tabs-link_active');$sortReviewDesc.addClass('b-comments__tabs-link_active');}
loadReviews(fakeOrderEl,fakeStatfilterEl,function(){$('.b-comment').first().addClass('b-comment_new');setTimeout(function(){$('.b-comment').first().removeClass('b-comment_new');},1000);});$('html, body').animate({scrollTop:$('#rvc-title-h2').offset().top},150);}
autosize(_newReview.find('textarea'));$('.rm-manager').removeClass('b-comments_no-border');try{var topicPath=dataLayer[0].dimension2;if(typeof topicPath!='undefined')
{dataLayer.push({'event':'gaEvent','eventCategory':'comment','eventAction':'comment','eventLabel':topicPath});}}catch(e){}
try{yaCounter1067243.reachGoal('comment_add');}catch(e){}}else if(data.mode=='edit'){var _expanded=_topReview.hasClass(options.classReviewReplies);var _newReview=$(data.html);_topReview.replaceWith(_newReview);if(_expanded){_newReview.addClass(options.classReviewReplies);}
autosize(_topReview.find('textarea'));}
$this.find('span[data-mark=5]').click();}else{var $fullForm=$this.closest('.b-comment-new_full-form');if(!$fullForm.length){$fullForm=$this;}
$fullForm.find(options.errorBlockSelector).addClass(options.classErrorShow)
$fullForm.find(options.errorTextSelector).html(data.errorMessage);setTimeout(function(){$fullForm.find(options.errorBlockSelector).fadeOut(200,function(){$fullForm.find(options.errorBlockSelector).removeClass(options.classErrorShow).show();});},5000);try{$this.find('TEXTAREA').focus();}catch(err){}}
document.dispatchEvent(eventCommentsLoaded)}});});$(document).on('click','.b-comment-new__state-btn',function(e){e.preventDefault();if($(this).attr('onclick')){return;}
openReviewForm();});$(document).on('click','.b-comment-new__close-btn',function(e){e.preventDefault();closeForm($(this).closest('.b-comment-new'));});$(document).on('click','.b-comment-new__tab-nav-item',function(e){e.preventDefault();var $this=$(this);var attr=$this.data('link');if($this.hasClass('b-comment-new__tab-nav-item_disabled')){showErrorForDisabledTab('Cреди ваших покупок нет этого товара. Вы можете оставлять отзывы только к товарам, которые покупали на OZ.by');return}
$('input[name=adminAnswer]').val(attr=='question'?1:0);$('.b-comment-new__tab-nav-item').removeClass('b-comment-new__tab-nav-item_active');$this.addClass('b-comment-new__tab-nav-item_active');resizeRail();var $container=$(this).closest('.b-comment-new');$container.find('textarea').each(function(index){$(this).attr('name','');});$container.find('.b-comment-new__tab').hide();$container.find('[data-tab='+attr+']').show().find('.b-comment-new__textarea_main').attr('name','message').focus();});$('.reviewsDateDesc, .reviewsRatingDesc').click(function(e){e.preventDefault();$this=$(this);if($this.hasClass('b-comments__tabs-link_active')||$this.closest('.b-comments-stat__filter-item').hasClass('b-comments-stat__filter-item_active')){return;}
if($('html').hasClass('mobile-yes')){$this.closest('.b-comments-stat__action-filter').find('.b-comments-stat__filter-item').removeClass('b-comments-stat__filter-item_active');$this.closest('.b-comments-stat__filter-item').addClass('b-comments-stat__filter-item_active');}else{$('.b-comments__tabs-link').removeClass('b-comments__tabs-link_active');$this.addClass('b-comments__tabs-link_active');}
loadReviews($this,$('input[name=comments-stat]:checked'));});$(document).on('change','input[name=comments-stat]',function(){if($('html').hasClass('mobile-yes')){var $el=$('.b-comments-stat__action-filter .b-comments-stat__filter-item_active a');}else{var $el=$('a.b-comments__tabs-link_active');}
loadReviews($el,$(this));});$('.b-product-title__rating-link').click(function(e){e.preventDefault();$reviewBlock=$('#rvc-title-h2');$('html, body').animate({scrollTop:$reviewBlock.offset().top},150);});$('.leaveReview').click(function(e){e.preventDefault();openReviewForm();scrollToReviewForm();});$(document).on('change','input[name=notBest]',function(e){var $this=$(this);var _data={reviewManager:1,ajax:1,idReview:$this.data('idReview'),action:'markAsBest',notBest:$this.prop('checked')?1:0}
$.ajax({url:_manager.find(options.formSelector).attr('action'),data:_data,method:'post',dataType:"json",success:function(data){$($this.next()).css('background-color','#F7FA00');$($this.next()).animate({backgroundColor:'#FFFFFF'},500);}});});$(document).on('change','input[name=answer]',function(e){var $this=$(this);var _data={reviewManager:1,ajax:1,idReview:$this.data('idReview'),action:'markAsAdminAnswer',answer:$this.prop('checked')?1:0}
$.ajax({url:_manager.find(options.formSelector).attr('action'),data:_data,method:'post',dataType:"json",success:function(data){$($this.next()).css('background-color','#F7FA00');$($this.next()).animate({backgroundColor:'#FFFFFF'},500);}});});function checkAnswerReview(){if(_manager.data('answerSelector')){var _selector=_manager.data('answerSelector');if($(_selector).length){$(_selector).addClass(options.classReviewAnswer);try{$(_selector).find('TEXTAREA').focus();}catch(e){}}}}
function checkAnchor(){if(window.location.hash&&window.location.hash!='')
{var currentUrl=new String(window.location.hash);var anchor=currentUrl.match(/#review_(\d{1,})/);var anchor2=currentUrl.match(/#review_(\d{1,}_0)/);if(anchor!=null&&anchor.length>0&&anchor2===null){anchor=anchor[0]+'_0';}
try{if($(window.location.hash))
{$('html, body').animate({scrollTop:$(anchor).offset().top},50);}}catch(e){}}}
function checkRAF(){var currentUrl=new String(window.location);var anchor=currentUrl.match(/#RAF/);if(anchor!=null&&anchor.length>0){openReviewForm();scrollToReviewForm();}}
function openReviewForm(){var $container=$('.b-comment-new_full-form');$container.addClass('b-comment-new_form-open');$container.find('.b-comment-new__tab').hide();setTimeout(function(){resizeRail();},0);$('.b-comment-new__tab-nav-item:not(.b-comment-new__tab-nav-item_disabled)').first().click();}
function scrollToReviewForm(){if($('.b-comments').hasClass('b-comments_empty')){var $elemToScroll=$('#rvc-title-h2');var scrollPx=0;}else{var $elemToScroll=$('.b-comment-new_full-form');var scrollPx=40;}
$('html, body').animate({scrollTop:$elemToScroll.offset().top-scrollPx},150);}
function closeForm($container){$('.b-comment-new__tab-nav-item').first().click();$container.find('textarea').each(function(index){$(this).val('');});$container.removeClass('b-comment-new_form-open');hideErrorForDisabledTab()}
function processDeleteRestoreReview($this,type){var _topReview=$this.closest(options.reviewSelector);var _data={reviewManager:1,ajax:1,idReview:_topReview.data('reviewId'),level:_topReview.data('reviewLevel'),type:type,action:type+'Review'}
$this.addClass(options.classButtonProcessing);$.ajax({url:_topReview.find(options.formSelector).attr('action'),data:_data,method:'post',dataType:"json",complete:function(data,status,xhr){$this.removeClass(options.classButtonProcessing);},success:function(data,status,xhr){if(data.success&&data.html){_topReview.replaceWith(data.html);autosize(_topReview.find('textarea'));if(data.statistics){$('.b-comments__col.b-comments__col_left').html(data.statistics);}
document.dispatchEvent(eventCommentsLoaded)}else{showActionError(_topReview,data.errorMessage);}}});}
function showActionError(topReview,message){if(topReview.data('timer')){clearTimeout(topReview.data('timer'));}
topReview.find(options.errorActionsBlockSelector).eq(0).addClass(options.classErrorShow).find(options.errorTextSelector).html(message);var _timer=setTimeout(function(){topReview.find(options.errorActionsBlockSelector).eq(0).fadeOut(200,function(){$(this).removeClass(options.classErrorShow).show();topReview.data('timer',null);});},3000);topReview.data('timer',_timer);}
function showErrorForDisabledTab(message){var $errorBlockSelector=$(options.errorDisabledTabSelector).find(options.errorBlockSelector);var timer=options.errorTimer;if(timer)clearTimeout(timer)
$errorBlockSelector.addClass(options.classErrorShow).find(options.errorTextSelector).html(message);options.errorTimer=setTimeout(function(){hideErrorForDisabledTab();},5000);}
function hideErrorForDisabledTab(){var $errorBlockSelector=$(options.errorDisabledTabSelector).find(options.errorBlockSelector)
var timer=options.errorTimer;if(timer)clearTimeout(timer)
$errorBlockSelector.removeClass(options.classErrorShow).find(options.errorTextSelector).html('');}
function resizeRail(){var $container=$('.b-comment-new_form-open');var elem=$container.find('.b-comment-new__tab-nav-item').filter('.b-comment-new__tab-nav-item_active');var leftPos=elem.position().left;var railWidth=elem.width();$container.find('.b-comment-new__track').css({transform:'translateX('+leftPos+'px)',width:railWidth});}
function loadReviews($orderEl,$statfilterEl,callback){var _data={reviewManager:1,ajax:1,action:'moreReview',fullExpand:1,order:$orderEl.hasClass('reviewsDateDesc')?1:0,statfilter:$statfilterEl.data('statfilter'),showDelayed:1}
$.ajax({url:'',data:_data,method:'post',dataType:"json",beforeSend:function(){$('.b-comments').addClass(options.classCommentsProcessing);},success:function(data,status,xhr){$('.b-comments').removeClass(options.classCommentsProcessing);if(data.success&&data.html){$('.rm-review-main-list').html(data.html);$('.rm-review-more-link-block').hide();if(data.total==1){$('.b-comments').addClass('b-comments_one');}else{$('.b-comments').removeClass('b-comments_one');}}else{}
document.dispatchEvent(eventCommentsLoaded)},complete:function(){if(typeof(callback)=='function'){callback();}}});}}
$(document).ready(function(){$.reviewManager('.rm-manager');});})(jQuery,window,document);;