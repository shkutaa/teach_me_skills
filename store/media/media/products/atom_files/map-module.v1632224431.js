jQuery(function($){function MapModule(options){this.isMapLoaded=false;this.isMapInit=false;this.$map=$(options.mapEl);this.mapId=this.$map.data('map-id');this.$allPageTriggers=options.$allPageTriggers;this.$allFullPageTriggers=options.$allFullPageTriggers;this.mapForDefaultTriggers=options.mapForDefaultTriggers;this.isInNav=options.mapEl.id==='navigationMap';this.isInLanding=options.mapEl.id==='landingMap';this.$menuItems=this.$map.find('.b-map-menu__link');this.$menuItemParents=this.$map.find('.b-map-menu__item');this.menuItemParentActive='b-map-menu__item_active';this.$select=this.$map.find('.b-map-menu select');this.$selectKey=this.$map.find('.b-map-menu .i-pseudolink__key');this.$switchers=this.$map.find('.map-city-switcher');this.placemarksArray=[];this.initialize();}
MapModule.prototype.initialize=function(){var self=this;this.setStaticVars();this.findTriggers();this.addLoadingListeners();if(this.isInNav||this.isInLanding){if(this.$map.data('map-show')=='show'){if(!this.isMapLoaded){this.loadMap(null,true);}}else{$('a[data-map-action=hover]').filter('[data-for-map="'+this.mapId+'"]').one('mouseenter',function(){if(!self.isMapLoaded){setTimeout(function(){self.loadMap(null,true);},200);}});}}};MapModule.prototype.findTriggers=function(){var self=this;this.$pageTriggers=this.$allPageTriggers.filter('[data-for-map="'+this.mapId+'"]').not('[data-map-action=hover]');this.$triggers=this.$pageTriggers.add(this.$map.find('[data-location]'));this.$fullMapTriggers=this.$allFullPageTriggers.filter(this.mapForDefaultTriggers!=this.mapId?'[data-for-map="'+this.mapId+'"]':function(index){return this.getAttribute('data-for-map')==self.mapId||!this.getAttribute('data-for-map');});};MapModule.prototype.addLoadingListeners=function(){var self=this;this.$triggers.one('click',function(e){if(!self.isMapLoaded){e.preventDefault();self.loadMap(this);}});this.$fullMapTriggers.one('click',function(e){if(!self.isMapLoaded){e.preventDefault();self.loadMap(this);}});};MapModule.prototype.loadMap=function(trigger,initOnHover){this.isMapLoaded=true;var self=this;this.storeMap=new StoreMapHandler({mapMenuClassName:'b-map-menu',triggerClassName:'b-map-menu__link',overlayClassName:'b-map__overlay',overlayHiddenClassName:'i-overlay_hidden',triggerItemClassName:'b-map-menu__item',triggerCloseClassName:'b-map__control_close',triggerParentActiveClassName:'b-map-menu__item_active',triggerPageSelector:'.b-product-stores__button .i-button',triggerPageSelector2:'.js_open_stores_window',switcherSelector:'.b-map-menu .i-switcher__name',listSelector:'.b-map-menu__list',listHiddenClassName:'b-map-menu__list_hidden',selectButtonActiveClass:'b-map-select__button_active',selectButtonSingleClass:'b-map-select__button_single',selectDropdownClass:'b-map-select__dropdown',switcherActiveClass:'b-map-select__dropdown-key_active',scheduleSelector:'.b-map-menu__line_dynamic'});this.storeMap.container=this.$map;this.storeMap.overlay=this.$map.find('.b-map__overlay');this.storeMap.triggerClose=this.$map.find('.b-map__control_close');this.storeMap.trigger=this.$map.find('.b-map-menu__link');this.storeMap.$switchers=this.$switchers.filter('[data-switcher-map="'+this.mapId+'"]');this.storeMap.$lists=this.$map.find('.b-map-menu__list');this.storeMap.menu=this.$map.find('.b-map-menu');this.storeMap.selectButton=this.$map.find('.b-map-select__button');this.storeMap.selectTitle=this.$map.find('.b-map-select__title');this.storeMap.triggerPage=this.$pageTriggers.add(this.$fullMapTriggers);this.storeMap.$menuItems=this.$menuItems;this.storeMap.$select=this.$select;this.storeMap.$selectKey=this.$selectKey;this.storeMap.$titleAll=this.$titleAll;this.storeMap.$titleAvail=this.$titleAvail;this.storeMap.$switcherCnt=this.$map.find('.b-map-select__aside-cnt');this.storeMap.init(locationStorage,trigger,initOnHover);this.storeMap.container.find('.b-map__popup').addClass('b-map__popup_processing');if(typeof ymaps==='undefined'){var mapAPI=document.createElement('script');mapAPI.src='//api-maps.yandex.ru/2.1.29/?lang=ru_RU';mapAPI.onload=function(){self.bindReadyListener(trigger,initOnHover);};document.head.appendChild(mapAPI);}else{this.bindReadyListener(trigger,initOnHover);}
if(this.isInNav){setTimeout(function(){initPerfectScrollbar();},0);}else{if(!this.isInLanding)initPerfectScrollbar();}
function initPerfectScrollbar(){self.storeMap.scroller=self.$map.find('.b-map-menu__list-scroller').perfectScrollbar({wheelPropagation:false,useKeyboard:false});}};MapModule.prototype.bindReadyListener=function(initialTrigger,initOnHover){var self=this;ymaps.ready(function(){self.setYmapsVars();self.addMainListeners();self.storeMap.api={updatePlacemarksAndShowFull:function(locations,city,presentInCurrentLocation,availableCities){self.updatePlacemarksAndShowFull(locations,city,presentInCurrentLocation,availableCities)},showFullAvailable:function(city,changeCityOnly){self.showFullAvailable(city,changeCityOnly);},redrawMap:function(){if(self.storesMap){self.storesMap.container.fitToViewport();}}};if(initialTrigger){if(!self.isMapInit)self.initMap(function(){initialTrigger.click();});}
if(initOnHover){if(!self.isMapInit){self.initMap(function(){self.showFullMap();if(self.discountCollection.length&&!self.isInLanding){var placemark=self.discountCollection.filter(function(item){return item.properties.get('newShopText');})[0];if(placemark&&placemark.properties.get('city')===currentLocation){self.showPromo();}else{self.stopPromo();}}});}}});};MapModule.prototype.initMap=function(cb){this.isMapInit=true;this.storeMap.container.find('.b-map__popup').removeClass('b-map__popup_processing');this.storesMap=new ymaps.Map(this.mapConfig.mapContainer,{center:this.mapConfig.defaultCenter,zoom:this.mapConfig.defaultZoom,controls:[]},{suppressMapOpenBlock:true});this.storesMap.controls.add(this.zoomControl,{position:{left:'10px',bottom:'10px'}});this.storesMap.behaviors.disable('scrollZoom');if(this.isInLanding&&!this.storeMap.isDesktop){this.storesMap.behaviors.disable('multiTouch');this.storesMap.behaviors.disable('drag');}
this.storesMap.geoObjects.add(this.storesCollection);cb();};MapModule.prototype.addMainListeners=function(){var self=this;this.$map.on('change:city',function(e,city){if(!city)return;self.showFullAvailable(city);});this.$map.on('change:shop',function(e,shop){if(!shop)return;self.storeMap.changeCity(locationStorage[shop].city);self.showShop(shop);});this.$select.on('change',function(e){if(this.value==='full'){var $selected=self.$select.find('option:selected');self.$selectKey.text($selected.html());self.showFullAvailable($selected.data('city'));}else{self.showShop(this.value);}});this.$fullMapTriggers.on('click',function(e){e.preventDefault();if(!self.isMapInit)self.initMap();self.showFullMap();});for(var place in locationStorage){if(locationStorage.hasOwnProperty(place)){var coord=locationStorage[place].coordinates,placemark=new ymaps.Placemark(coord),$bindedTrigger=self.$triggers.filter('[data-location='+place+']'),hasDiscount,isNewShop,isStranaOz;this.placemarksArray.push(placemark);self.placemarks[place]=placemark;(function(placemark,trigger){self.storesCollection.add(placemark);hasDiscount=this.locationStorage[place].discount||false;isNewShop=this.locationStorage[place].newShop||false;isStranaOz=this.locationStorage[place].stranaOz||false;if(isNewShop)self.discountCollection.push(placemark);placemark.properties.set({name:this.locationStorage[place].name,id:this.locationStorage[place].id,image:this.locationStorage[place].image,address:this.locationStorage[place].address,link:this.locationStorage[place].link,city:this.locationStorage[place].city,cityName:this.locationStorage[place].cityName,discount:hasDiscount,discountText:this.locationStorage[place].discountText,newShop:isNewShop,stranaOz:isStranaOz,newShopText:this.locationStorage[place].newShopText});trigger.on('click',function(){var $target=$(this),locations=$target.data('locations'),location=$target.data('location');if(!self.isMapInit)self.initMap();if(locations){self.storeMap.updateMenu(locations,locationStorage[location].name,locationStorage[location].city);self.updatePlacemarks(locations,self.placemarks,function(){self.updateMapAndOpenBalloon(placemark);});}else{self.updateMapAndOpenBalloon(placemark);}});if(placemark.properties.get('discount')){placemark.options.set({balloonLayout:self.discountBalloonLayout,balloonContentLayout:self.discountBalloonContentLayout});placemark.options.set({'iconImageHref':self.mapConfig.iconDiscountImage,iconImageSize:[44,44],iconImageOffset:[-22,-22]});}
if(placemark.properties.get('newShop')){if(self.isInNav&&placemark.properties.get('newShopText')){placemark.options.set({balloonLayout:self.newShopBalloonLayout,balloonContentLayout:self.newShopBalloonContentLayout});}
placemark.options.set('iconImageHref',self.mapConfig.iconGreenImage);}
if(placemark.properties.get('stranaOz')){placemark.options.set({balloonLayout:self.stranaOzBalloonLayout,balloonContentLayout:self.stranaOzBalloonContentLayout});placemark.options.set({'iconImageHref':self.mapConfig.iconStranaOzImage,iconImageSize:[62,62],iconImageOffset:[-31,-31]});}
placemark.events.add('click',function(e){trigger.parent().siblings().removeClass(self.storeMap.triggerParentActiveClassName);trigger.parent().addClass(self.storeMap.triggerParentActiveClassName);var mapSize=self.storesMap.container.getSize();placemark.options.set('balloonAutoPanMargin',[(mapSize[1]-240)/2-20,(mapSize[0]-230)/2,(mapSize[1]-240)/2+20,(mapSize[0]-230)/2]);}).add('mouseenter',function(e){var target=e.get('target'),image=getHoverImage({isNewShop:target.properties.get('newShop'),isDiscount:target.properties.get('discount'),isStranaOz:target.properties.get('stranaOz'),hover:true});self.changeIcon(target,image);}).add('mouseleave',function(e){var target=e.get('target'),image=getHoverImage({isNewShop:target.properties.get('newShop'),isDiscount:target.properties.get('discount'),isStranaOz:target.properties.get('stranaOz'),});if(!target.balloon.isOpen()){self.changeIcon(target,image)}}).add('balloonopen',function(e){var target=e.get('target'),image=getHoverImage({isNewShop:target.properties.get('newShop'),isDiscount:target.properties.get('discount'),isStranaOz:target.properties.get('stranaOz'),hover:true});self.changeIcon(target,image);self.changeSelect(target.properties.get('id'),target.properties.get('name')+', '+target.properties.get('cityName'));setTimeout(function(){self.$map.trigger('shop:changed',[target.properties.get('id'),target.properties.get('city')]);});}).add('balloonclose',function(e){var target=e.get('target'),image=getHoverImage({isNewShop:target.properties.get('newShop'),isDiscount:target.properties.get('discount'),isStranaOz:target.properties.get('stranaOz')});self.changeIcon(target,image);if(self.isPromoRunning){self.stopPromo();}});}(placemark,$bindedTrigger));}}
function getHoverImage(options){var image;if(options.isNewShop){image=options.hover?self.mapConfig.iconGreenHoverImage:self.mapConfig.iconGreenImage;}else if(options.isDiscount){image=options.hover?self.mapConfig.iconDiscountHoverImage:self.mapConfig.iconDiscountImage;}else if(options.isStranaOz){image=options.hover?self.mapConfig.iconStranaOzHoverImage:self.mapConfig.iconStranaOzImage;}else{image=options.hover?self.mapConfig.iconHoverImage:self.mapConfig.iconImage;}
return image;}};MapModule.prototype.showShop=function(shopId){var mapSize=this.storesMap.container.getSize();if(this.storesMap.getZoom()<17)this.storesMap.setZoom(this.mapConfig.defaultZoom);this.placemarks[shopId].options.set('balloonAutoPanMargin',[(mapSize[1]-240)/2-20,(mapSize[0]-230)/2,(mapSize[1]-240)/2+20,(mapSize[0]-230)/2]);this.placemarks[shopId].balloon.open();};MapModule.prototype.changeSelect=function(value,text){var self=this;this.$select.find('option').each(function(index,option){if(option.value===value){self.$select.get(0).value=value;self.$selectKey.text(text);}});};MapModule.prototype.updatePlacemarksAndShowFull=function(locations,city,presentInCurrentLocation,availableCities){this.updatePlacemarks(locations,this.placemarks,this.showFullAvailable.bind(this,city,true,locations,presentInCurrentLocation,availableCities));};MapModule.prototype.updatePlacemarks=function(locations,placemarks,cb){var self=this;var actualLength=this.storesCollection.getLength();if(actualLength<this.storesLength||locations.length<this.storesLength){this.storesCollection.removeAll();$.each(jQuery.isArray(locations)?locations:JSON.parse(locations),function(index,item){self.storesCollection.add(placemarks[item]);});}
cb();};MapModule.prototype.showFullAvailable=function(city,changeCityOnly,locations,presentInCurrentLocation,availableCities){var self=this;this.$menuItemParents.filter('.'+this.menuItemParentActive).removeClass(this.menuItemParentActive);this.storesMap.balloon.close();var mapCenter=city!=='minsk'?this.mapConfig.altCenter[city]:this.mapConfig.defaultCenter;var mapScale=city!=='minsk'?12:11;var storesCnt=0;var location;if(availableCities&&availableCities.length>1&&!presentInCurrentLocation){mapCenter=this.mapConfig.fullMapCenter;mapScale=6;}
this.storesCollection.each(function(item){if(item.properties.get('city')===city){storesCnt++;location=item.properties.get('id');}});this.storeMap.changeCity(city,changeCityOnly,locations);if(storesCnt===1&&(!availableCities||availableCities.length===1||presentInCurrentLocation)){setTimeout(function(){self.storeMap.visibleList.find('.b-map-menu__link[data-location='+location+']').trigger('click');},100);}else{this.storesCollection.getMap().setCenter(mapCenter,mapScale);}};MapModule.prototype.showFullMap=function(){var self=this;var city=currentLocation||this.storeMap.defaultMapId;var mapCenter=currentLocation?this.mapConfig.altCenter[currentLocation]:this.mapConfig.defaultCenter;var mapScale=this.mapConfig.altScale[city];var storesCnt=0;var location;this.storesCollection.removeAll();$.each(this.placemarks,function(index,item){self.storesCollection.add(item);});this.storesCollection.each(function(item){if(item.properties.get('city')===city){storesCnt++;location=item.properties.get('id');}});this.$menuItems.each(function(index,item){item.style.display='block';});this.$menuItemParents.filter('.'+this.menuItemParentActive).removeClass(this.menuItemParentActive);this.$select.find('option').each(function(index,item){item.disabled=false;});this.storeMap.updateMenuFull();this.$selectKey.text('Выберите магазин');if(storesCnt===1){setTimeout(function(){self.storeMap.visibleList.find('.b-map-menu__link[data-location='+location+']').trigger('click');},100);}else{this.storesCollection.getMap().setCenter(mapCenter,mapScale);}
this.$map.trigger('city:changed',[city]);};MapModule.prototype.showPromo=function(){var self=this;this.isPromoRunning=true;setTimeout(function(){self.openPromo();},1000);};MapModule.prototype.openPromo=function(){var placemark,isNewShop,mapSize;mapSize=this.storesMap.container.getSize();if(this.discountCollection.length){placemark=this.discountCollection.filter(function(item){return item.properties.get('newShopText');})[0];}
isNewShop=placemark.properties.get('newShop');placemark.options.set('balloonAutoPanMargin',[mapSize[1]-260,(mapSize[0]-(isNewShop?160:90))/2,mapSize[1]-200,(mapSize[0]-(isNewShop?160:90))/2]);if(placemark.properties.get('city')!=='minsk')this.storesCollection.getMap().setZoom(12);placemark.balloon.open();};MapModule.prototype.stopPromo=function(){var self=this;clearInterval(this.promoInterval);this.isPromoRunning=false;this.discountCollection.forEach(function(item){if(item.balloon.isOpen())item.balloon.close();item.options.set({balloonLayout:self.balloonLayout,balloonContentLayout:self.balloonContentLayout});});};MapModule.prototype.updateMapAndOpenBalloon=function(placemark){if(this.storesCollection.getMap().getZoom()<17)this.storesCollection.getMap().setZoom(this.mapConfig.defaultZoom);var mapSize=this.storesMap.container.getSize();placemark.options.set('balloonAutoPanMargin',[(mapSize[1]-240)/2-20,(mapSize[0]-230)/2,(mapSize[1]-240)/2+20,(mapSize[0]-230)/2]);placemark.balloon.open();};MapModule.prototype.changeIcon=function(target,icon){target.options.set('iconImageHref',icon);};MapModule.prototype.setStaticVars=function(){this.placemarks={};this.storesLength=Object.keys(locationStorage).length;this.mapConfig={mapContainer:this.$map.find('.b-map-main__container').get(0),mapControlClassName:'b-map-control',mapControlIconClassName:'b-map-control__icon',mapBalloonClassName:'b-map-balloon',mapBalloonArrowClassName:'b-map-balloon__arrow',mapDiscountBalloonClassName:'b-map-balloon-discount',mapDiscountBalloonArrowClassName:'b-map-balloon-discount__arrow',mapBalloonCrossClassName:'b-map-balloon__close',mapNewShopBalloonClassName:'b-map-balloon-new-shop',mapNewShopBalloonArrowClassName:'b-map-balloon-new-shop__arrow',defaultCenter:[53.90054923,27.55902557],altCenter:{minsk:[53.90054923,27.55902557],brest:[52.0975500,23.6877500],gomel:[52.423468,30.9943597],grodno:[53.677834,23.829529],vitebsk:[55.184217,30.202878],mogilev:[53.894548,30.330654]},altScale:{minsk:11,brest:15,gomel:14,grodno:12,vitebsk:12,mogilev:12},fullMapCenter:[53.8,27.5],defaultZoom:17,defaultControls:[],iconImage:'/img/module-map/map-placemark.png',iconHoverImage:'/img//module-map/map-placemark-hover.png',iconGreenImage:'/img/module-map/map-placemark-green.png',iconGreenHoverImage:'/img/module-map/map-placemark-green-hover.png',iconDiscountImage:'/img/module-map/map-placemark-discount.png',iconDiscountHoverImage:'/img/module-map/map-placemark-discount-hover.png',iconStranaOzImage:'/img/module-map/map-placemark-strana-oz.png',iconStranaOzHoverImage:'/img/module-map/map-placemark-strana-oz-hover.png',storeImagePath:'/img/module-map/stores/',defaultTransitionTime:800};this.discountCollection=[];this.isPromoRunning=false;this.baloonCoords=window.innerWidth>767?[70,180,180,180]:(document.documentElement.classList&&document.documentElement.classList.contains('html_ios')?(window.innerWidth-230)/2:[window.innerHeight/7,(window.innerWidth-232)/2,window.innerHeight/4,(window.innerWidth-232)/2]);};MapModule.prototype.setYmapsVars=function(){var self=this;this.controlButtons=ymaps.templateLayoutFactory.createClass("<div>"+"<div id='zoom-in' class='"+this.mapConfig.mapControlClassName+(!this.storeMap.isDesktop?' '+this.mapConfig.mapControlClassName+'_no-hover':'')+"'><i class='"+this.mapConfig.mapControlIconClassName+' '+this.mapConfig.mapControlIconClassName+'_plus'+"'></i></div>"+"<div id='zoom-out' class='"+this.mapConfig.mapControlClassName+(!this.storeMap.isDesktop?' '+this.mapConfig.mapControlClassName+'_no-hover':'')+"'><i class='"+this.mapConfig.mapControlIconClassName+"'></i></div>"+"</div>",{build:function(){this.constructor.superclass.build.call(this);this.zoomInCallback=ymaps.util.bind(this.zoomIn,this);this.zoomOutCallback=ymaps.util.bind(this.zoomOut,this);self.$map.find('#zoom-in').bind('click',this.zoomInCallback);self.$map.find('#zoom-out').bind('click',this.zoomOutCallback);},clear:function(){self.$map.find('#zoom-in').unbind('click',this.zoomInCallback);self.$map.find('#zoom-out').unbind('click',this.zoomOutCallback);this.constructor.superclass.clear.call(this);},zoomIn:function(){var map=this.getData().control.getMap();this.events.fire('zoomchange',{oldZoom:map.getZoom(),newZoom:map.getZoom()+1});},zoomOut:function(){var map=this.getData().control.getMap();this.events.fire('zoomchange',{oldZoom:map.getZoom(),newZoom:map.getZoom()-1});}});this.zoomControl=new ymaps.control.ZoomControl({options:{layout:this.controlButtons}});this.balloonLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapBalloonClassName+'">'+'<div class="'+this.mapConfig.mapBalloonClassName+'__inner">'+'$[[options.contentLayout observeSize minWidth=230 maxWidth=230 maxHeight=350]]'+'</div>'+'<div id="closeBalloon" class="'+this.mapConfig.mapBalloonCrossClassName+'"><span class="i-icon-2 i-icon-2_close"></span></div>'+'<div class="'+this.mapConfig.mapBalloonArrowClassName+'"></div>'+'</div>',{build:function(){this.constructor.superclass.build.call(this);this._$element=$('.'+self.mapConfig.mapBalloonClassName,this.getParentElement());this.applyElementOffset();this._$element.find('#closeBalloon').on('click',$.proxy(this.fireCloseEvent,this));},fireCloseEvent:function(e){e.preventDefault();e.stopPropagation();this.events.fire('userclose');},onSublayoutSizeChange:function(){self.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments);if(!this._isElement(this._$element)){return;}
this.applyElementOffset();this.events.fire('shapechange');},applyElementOffset:function(){this._$element.css({left:-(this._$element[0].offsetWidth/2),top:-(this._$element[0].offsetHeight+(this._$element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0].offsetHeight*2)+9)});},getShape:function(){if(!this._isElement(this._$element)){return self.balloonLayout.superclass.getShape.call(this);}
var position=this._$element.position();return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[position.left,position.top],[position.left+this._$element[0].offsetWidth,position.top+this._$element[0].offsetHeight+this._$element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0].offsetHeight]]));},_isElement:function(element){return element&&element[0]&&element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0];}});this.balloonContentLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapBalloonClassName+'__top">'+'<img width="230" height="130" class="'+this.mapConfig.mapBalloonClassName+'__image" src='+
this.mapConfig.storeImagePath+'{{ properties.image }}>'+'</div>'+'<div class="'+this.mapConfig.mapBalloonClassName+'__main">'+'<p>$[properties.address]</p>'+'<a href={{properties.link}} class="'+this.mapConfig.mapBalloonClassName+'__button">Посмотреть ассортимент</a>'+'</div>');this.discountBalloonLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapBalloonClassName+' '+this.mapConfig.mapBalloonClassName+"_discount"+'">'+'<div class="'+this.mapConfig.mapBalloonClassName+'__inner">'+'$[[options.contentLayout observeSize minWidth=230 maxWidth=230 maxHeight=350]]'+'</div>'+'<div id="closeBalloon" class="'+this.mapConfig.mapBalloonCrossClassName+'"><span class="i-icon-2 i-icon-2_close"></span></div>'+'<div class="'+this.mapConfig.mapBalloonArrowClassName+'"></div>'+'</div>',{build:function(){this.constructor.superclass.build.call(this);this._$element=$('.'+self.mapConfig.mapBalloonClassName,this.getParentElement());this.applyElementOffset();this._$element.find('#closeBalloon').on('click',$.proxy(this.fireCloseEvent,this));},fireCloseEvent:function(e){e.preventDefault();e.stopPropagation();this.events.fire('userclose');},onSublayoutSizeChange:function(){self.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments);if(!this._isElement(this._$element)){return;}
this.applyElementOffset();this.events.fire('shapechange');},applyElementOffset:function(){this._$element.css({left:-(this._$element[0].offsetWidth/2),top:-(this._$element[0].offsetHeight+(this._$element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0].offsetHeight*2)+9)});},getShape:function(){if(!this._isElement(this._$element)){return self.balloonLayout.superclass.getShape.call(this);}
var position=this._$element.position();return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[position.left,position.top],[position.left+this._$element[0].offsetWidth,position.top+this._$element[0].offsetHeight+this._$element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0].offsetHeight]]));},_isElement:function(element){return element&&element[0]&&element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0];}});this.discountBalloonContentLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapBalloonClassName+'__top">'+'<img width="230" height="130" class="'+this.mapConfig.mapBalloonClassName+'__image" src='+
this.mapConfig.storeImagePath+'{{ properties.image }}>'+'<div class="'+this.mapConfig.mapBalloonClassName+'__label">$[properties.discountText]</div>'+'</div>'+'<div class="'+this.mapConfig.mapBalloonClassName+'__main">'+'<p>$[properties.address]</p>'+'<a href={{properties.link}} class="'+this.mapConfig.mapBalloonClassName+'__button">Посмотреть ассортимент</a>'+'</div>');this.newShopBalloonLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapNewShopBalloonClassName+'">'+'<div class="'+this.mapConfig.mapNewShopBalloonClassName+'__inner">'+'$[[options.contentLayout observeSize minWidth=160 maxWidth=160 maxHeight=170]]'+'</div>'+'<div class="'+this.mapConfig.mapNewShopBalloonArrowClassName+'"></div>'+'</div>',{build:function(){this.constructor.superclass.build.call(this);this._$element=$('.'+self.mapConfig.mapNewShopBalloonClassName,this.getParentElement());this.applyElementOffset();},onSublayoutSizeChange:function(){self.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments);if(!this._isElement(this._$element)){return;}
this.applyElementOffset();this.events.fire('shapechange');},applyElementOffset:function(){this._$element.css({left:-(this._$element[0].offsetWidth/2),top:-(this._$element[0].offsetHeight+(this._$element.find('.'+self.mapConfig.mapNewShopBalloonArrowClassName)[0].offsetHeight*2)+9)});},getShape:function(){if(!this._isElement(this._$element)){return self.balloonLayout.superclass.getShape.call(this);}
var position=this._$element.position();return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[position.left,position.top],[position.left+this._$element[0].offsetWidth,position.top+this._$element[0].offsetHeight+this._$element.find('.'+self.mapConfig.mapNewShopBalloonArrowClassName)[0].offsetHeight]]));},_isElement:function(element){return element&&element[0]&&element.find('.'+self.mapConfig.mapNewShopBalloonArrowClassName)[0];}});this.newShopBalloonContentLayout=ymaps.templateLayoutFactory.createClass('<span class="'+this.mapConfig.mapNewShopBalloonClassName+'__text">$[properties.newShopText]</span>');this.stranaOzBalloonLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapBalloonClassName+'">'+'<div class="'+this.mapConfig.mapBalloonClassName+'__inner">'+'$[[options.contentLayout observeSize minWidth=230 maxWidth=230 maxHeight=350]]'+'</div>'+'<div id="closeBalloon" class="'+this.mapConfig.mapBalloonCrossClassName+'"><span class="i-icon-2 i-icon-2_close"></span></div>'+'<div class="'+this.mapConfig.mapBalloonArrowClassName+'"></div>'+'</div>',{build:function(){this.constructor.superclass.build.call(this);this._$element=$('.'+self.mapConfig.mapBalloonClassName,this.getParentElement());this.applyElementOffset();this._$element.find('#closeBalloon').on('click',$.proxy(this.fireCloseEvent,this));},fireCloseEvent:function(e){e.preventDefault();e.stopPropagation();this.events.fire('userclose');},onSublayoutSizeChange:function(){self.balloonLayout.superclass.onSublayoutSizeChange.apply(this,arguments);if(!this._isElement(this._$element)){return;}
this.applyElementOffset();this.events.fire('shapechange');},applyElementOffset:function(){this._$element.css({left:-(this._$element[0].offsetWidth/2),top:-(this._$element[0].offsetHeight+(this._$element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0].offsetHeight*2)+22)});},getShape:function(){if(!this._isElement(this._$element)){return self.balloonLayout.superclass.getShape.call(this);}
var position=this._$element.position();return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[position.left,position.top],[position.left+this._$element[0].offsetWidth,position.top+this._$element[0].offsetHeight+this._$element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0].offsetHeight]]));},_isElement:function(element){return element&&element[0]&&element.find('.'+self.mapConfig.mapBalloonArrowClassName)[0];}});this.stranaOzBalloonContentLayout=ymaps.templateLayoutFactory.createClass('<div class="'+this.mapConfig.mapBalloonClassName+'__top">'+'<img width="230" height="130" class="'+this.mapConfig.mapBalloonClassName+'__image" src='+
this.mapConfig.storeImagePath+'{{ properties.image }}>'+'</div>'+'<div class="'+this.mapConfig.mapBalloonClassName+'__main">'+'<p>$[properties.address]</p>'+'<a href={{properties.link}} class="'+this.mapConfig.mapBalloonClassName+'__button">Посмотреть ассортимент</a>'+'</div>');this.placemarkConfig={iconLayout:'default#image',iconImageHref:this.mapConfig.iconImage,iconImageSize:[34,34],iconImageOffset:[-17,-17],hideIconOnBalloonOpen:false,balloonCloseButton:false,balloonLayout:this.balloonLayout,balloonContentLayout:this.balloonContentLayout,balloonShadow:false,balloonPanelMaxMapArea:0,balloonAutoPanMargin:this.baloonCoords,balloonAutoPanCheckZoomRange:true};this.storesCollection=new ymaps.GeoObjectCollection({},this.placemarkConfig)};var $maps=$('.b-map'),$allPageTriggers=$('[data-for-map]'),$fullPageTriggers=$('[data-map=full]').not('.js_open_stores_window').add($('.js_open_stores_window').not('[data-location]')),maps={};$maps.each(function(index,item){maps[item.getAttribute('data-map-id')]=new MapModule({mapEl:item,$allPageTriggers:$allPageTriggers,$allFullPageTriggers:$fullPageTriggers,mapForDefaultTriggers:1});});}(jQuery));;