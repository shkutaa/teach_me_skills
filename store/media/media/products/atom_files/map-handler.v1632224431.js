var StoreMapHandler=function(options){'use strict';this.$document=jQuery(document);this.$html=jQuery('html');this.$body=this.$html.find('body');this.htmlHasOverlayMod='html_has-overlay';this.ESC_KEY_CODE=27;this.isDesktop=this.$html.hasClass('mobile-no');this.isIOS=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);this.overlayClassName=options.overlayClassName;this.overlayHiddenClassName=options.overlayHiddenClassName;this.triggerCloseClassName=options.triggerCloseClassName;this.triggerClassName=options.triggerClassName;this.listHiddenClassName=options.listHiddenClassName;this.triggerClassName=options.triggerClassName;this.triggerPageSelector=options.triggerPageSelector;this.triggerParentActiveClassName=options.triggerParentActiveClassName;this.selectDropdownClass=options.selectDropdownClass;this.selectButtonActiveClass=options.selectButtonActiveClass;this.selectButtonSingleClass=options.selectButtonSingleClass;this.switcherActiveClass=options.switcherActiveClass;this.scheduleSelector=options.scheduleSelector;this.popupIsOpen=false;this.selectIsOpen=false;this.fullMapId='belarus';this.defaultMapId='minsk';this.defaultSelectKey='Выберите магазин';};StoreMapHandler.prototype.init=function(locationStorage,trigger,initOnHover){var self=this;this.locationStorage=locationStorage;if(this.$switchers.length)this.selectedSwitcher=this.$switchers.siblings('input:checked');this.visibleList=this.$lists.not('.'+this.listHiddenClassName);this.schedule=this.container.find(this.scheduleSelector);this.trigger.on('click',function(e){e.preventDefault();self.setBoundLocation(this,self.menuMutations);});this.triggerPage.on('click',function(e){e.preventDefault();self.handlePageTrigger(this);});this.triggerClose.on('click',function(e){e.preventDefault();self.closePopup();});this.selectButton.on('click',function(e){e.preventDefault();self.handleSelect();});if(this.$switchers.length){this.$switchers.on('click',function(e){e.preventDefault();self.showFullAvailableMap(this.getAttribute('data-switcher-city'),true);self.closeSelect();});}
this.container.on('shop:changed',this.handleShopChanged.bind(this));this.container.on('city:changed',this.handleCityChanged.bind(this));if(trigger&&!initOnHover){trigger.click();if(trigger.getAttribute('data-map')==='full'||!trigger.getAttribute('data-location')){this.updateMenuFull();}else{this.updateMenu(trigger.getAttribute('data-locations'),locationStorage[trigger.getAttribute('data-location')].name,trigger.getAttribute('data-map-text')=='full');}}
this.$switcherCnt.text((Object.keys(citiesStorage).length-1)+' '+this.pluralize(Object.keys(citiesStorage).length-1,['город','города','городов']));};StoreMapHandler.prototype.handleShopChanged=function(e,shopId){if(locationStorage[shopId].city!==this.currentCity){this.changeCity(locationStorage[shopId].city,true);}else{this.changeSchedule(shopId);}};StoreMapHandler.prototype.handleCityChanged=function(e,cityId){this.changeSchedule(cityId);};StoreMapHandler.prototype.handlePageTrigger=function(trigger){this.changeCity(this.getMapLocation(trigger.getAttribute('data-city'),trigger.getAttribute('data-locations')),false);if(!this.popupIsOpen)this.openPopup(trigger);this.setBoundLocation(trigger,this.menuMutations);};StoreMapHandler.prototype.getMapLocation=function(city,locations){if(city)return city;if(!locations)return currentLocation||this.defaultMapId;var locs=jQuery.isArray(locations)?locations:JSON.parse(locations);var isLocationCityPresent=this.checkLocationPresence(locs);var availableCities=this.getAvailableCities(locs);var defaultMapLocation=~availableCities.indexOf(this.defaultMapId)?this.defaultMapId:availableCities[0];if(!currentLocation)return defaultMapLocation;return isLocationCityPresent?currentLocation:defaultMapLocation;};StoreMapHandler.prototype.checkLocationPresence=function(locations){var isLocationCityPresent=false;locations.forEach(function(location){if(locationStorage[location].city===currentLocation){isLocationCityPresent=true;return false;}});return isLocationCityPresent;};StoreMapHandler.prototype.openPopup=function(trigger){var self=this;this.popupIsOpen=true;if(trigger.getAttribute('data-map-type')==='single'){if(!this.container.hasClass('b-map_single')){this.container.addClass('b-map_single');setTimeout(function(){if(self.api)self.api.redrawMap();},0);}}else{if(this.container.hasClass('b-map_single')){this.container.removeClass('b-map_single');setTimeout(function(){if(self.api)self.api.redrawMap();},0);}}
if(this.isDesktop){this.checkScrollbar();this.setScrollbar();this.adjustDialog();}else{var $trigger=jQuery(trigger);if($trigger.hasClass('js_open_stores_window')){var $dropdown=$trigger.parents('.ppnav-outside--active');if($dropdown.length)$dropdown.removeClass('ppnav-outside--active').siblings('.ppnav-backdrop').css('display','none');}}
if(!this.isIOS){this.$html.addClass(this.htmlHasOverlayMod);}
this.overlay.removeClass(this.overlayHiddenClassName);this.$html.on('touchstart click',this.mapClickHandler=function(e){e.stopPropagation();if(jQuery(e.target).hasClass(self.overlayClassName)){self.closePopup();}});this.$document.on('keyup',this.mapKeyHandler=function(e){if(e.which===self.ESC_KEY_CODE){self.closePopup();}});};StoreMapHandler.prototype.handleSelect=function(e){if(this.selectIsOpen){this.closeSelect();}else{this.openSelect();}};StoreMapHandler.prototype.openSelect=function(e){var self=this;this.selectIsOpen=true;this.selectButton.addClass(this.selectButtonActiveClass);setTimeout(function(){self.$body.on('click.selectCity',function(e){var $target=jQuery(e.target);if(!$target.parents('.'+self.selectDropdownClass).length){self.closeSelect();}});});};StoreMapHandler.prototype.closeSelect=function(){this.selectIsOpen=false;this.selectButton.removeClass(this.selectButtonActiveClass);this.$body.off('click.selectCity');};StoreMapHandler.prototype.closePopup=function(){this.popupIsOpen=false;this.$html.off('click',this.mapClickHandler);this.$html.off('touchstart',this.mapClickHandler);this.$document.off('keyup',this.mapKeyHandler);if(this.isDesktop){this.resetAdjustments();this.resetScrollbar();}
this.$html.removeClass(this.htmlHasOverlayMod);this.overlay.addClass(this.overlayHiddenClassName);};StoreMapHandler.prototype.setBoundLocation=function(elem,cb){var $el=jQuery(elem);var locationAttr=$el.data('location');var locations=$el.data('locations');if(locationAttr&&jQuery.isFunction(cb)){cb.call(this,locationAttr);}else{if(locations){if(!$el.data('location')&&this.api){this.updateMenu(locations,'',this.getMapLocation(null,locations));this.api.updatePlacemarksAndShowFull(locations,this.getMapLocation(null,locations),this.checkLocationPresence(locations),this.getAvailableCities(locations));}}else{this.updateMenuFull();}}};StoreMapHandler.prototype.menuMutations=function(place){var $boundTrigger=this.container.find('[data-location='+place+']');if(this.locationStorage[place]){this.trigger.not($boundTrigger).parent(this.trigger).removeClass(this.triggerParentActiveClassName);$boundTrigger.parent(this.trigger).addClass(this.triggerParentActiveClassName);}};StoreMapHandler.prototype.changeCity=function(city,changeCityOnly){var self=this;this.changeSwitcher(city,null,changeCityOnly);if(this.visibleList.data('list')!==city){this.visibleList.addClass(this.listHiddenClassName);this.setVisibleList(city===this.fullMapId?this.defaultMapId:city);}
setTimeout(function(){if(self.scroller)self.scroller.perfectScrollbar('update');},0);this.container.trigger('city:changed',[city===this.fullMapId?this.defaultMapId:city]);};StoreMapHandler.prototype.changeSchedule=function(id){this.schedule.html(scheduleStorage[id]);};StoreMapHandler.prototype.getAvailableCities=function(locations){var locs=jQuery.isArray(locations)?locations:JSON.parse(locations);if(!locs)return[];return locs.reduce(function(prev,next){var nextArr=prev;if(!~nextArr.indexOf(locationStorage[next].city)){nextArr.push(locationStorage[next].city);}
return nextArr;},[]);};StoreMapHandler.prototype.showFullAvailableMap=function(city,changeCityOnly){this.api.showFullAvailable(city,changeCityOnly);};StoreMapHandler.prototype.changeSwitcher=function(cityId,cities,changeCityOnly){this.$switchers.filter('.'+this.switcherActiveClass).removeClass(this.switcherActiveClass);this.$switchers.filter('[data-switcher-city='+cityId+']').addClass(this.switcherActiveClass);this.selectTitle.text(citiesStorage[cityId]);this.currentCity=cityId;if(cities){this.$switchers.each(function(index,item){cities.indexOf(item.getAttribute('data-switcher-city'))===-1?item.style.display='none':item.style.display='';});this.$switcherCnt.text((cities.length-1)+' '+this.pluralize(cities.length-1,['город','города','городов']));}else{if(!changeCityOnly){this.$switchers.each(function(index,item){item.style.display='';});this.$switcherCnt.text((Object.keys(citiesStorage).length-1)+' '+this.pluralize(Object.keys(citiesStorage).length-1,['город','города','городов']));}}};StoreMapHandler.prototype.setVisibleList=function(city){this.visibleList=this.$lists.filter(function(index,item){if(typeof city==='string'){return item.getAttribute('data-list')===city;}else if(city.length>0){return~city.indexOf(item.getAttribute('data-list'));}else{return true;}});this.visibleList.removeClass(this.listHiddenClassName);};StoreMapHandler.prototype.updateMenu=function(locs,location,cityId){var self=this,cities=[],city,locations=jQuery.isArray(locs)?locs:JSON.parse(locs);jQuery.each(locations,function(index,item){city=locationStorage[item].city;if(cities.indexOf(city))cities.push(city);});this.$menuItems.each(function(index,item){if(locations.indexOf(item.getAttribute('data-location'))!==-1){item.style.display='block';}else{item.style.display='none';}});this.$select.find('option').each(function(index,item){if(item.value==='divider')return item.disabled=true;item.disabled=locations.indexOf(item.value)===-1&&cities.indexOf(item.getAttribute('data-city'))===-1;});self.$selectKey.text(location||this.defaultSelectKey);cities.length<2?this.selectButton.addClass(this.selectButtonSingleClass):this.selectButton.removeClass(this.selectButtonSingleClass);if(cityId)this.changeSwitcher(cityId,cities);};StoreMapHandler.prototype.updateMenuFull=function(){this.$menuItems.each(function(index,item){item.style.display='block';});this.$select.find('option').each(function(index,item){if(item.value==='divider')return item.disabled=true;item.disabled=false;});this.selectButton.removeClass(this.selectButtonSingleClass);this.changeCity(currentLocation||this.defaultMapId);this.$selectKey.text(this.defaultSelectKey);};StoreMapHandler.prototype.pluralize=function(count,variants){return variants[(count%100>4&&count%100<20)?2:[2,0,1,1,1,2][(count%10<5)?count%10:5]];};StoreMapHandler.prototype.checkScrollbar=function(){var fullWindowWidth=window.innerWidth;this.bodyIsOverflowing=document.body.clientWidth<fullWindowWidth;this.scrollbarWidth=this.measureScrollbar()};StoreMapHandler.prototype.setScrollbar=function(){var bodyPad=parseInt((this.$body.css('padding-right')||0),10);this.originalBodyPad=document.body.style.paddingRight||'';if(this.bodyIsOverflowing){this.$body.css('padding-right',bodyPad+this.scrollbarWidth).css('background-position','calc(50% - '+this.scrollbarWidth/2+'px) 0');}};StoreMapHandler.prototype.resetScrollbar=function(){this.$body.css('padding-right',this.originalBodyPad).css('background-position','');};StoreMapHandler.prototype.resetAdjustments=function(){this.overlay.css({paddingLeft:'',paddingRight:''})};StoreMapHandler.prototype.measureScrollbar=function(){var scrollDiv=document.createElement('div');jQuery(scrollDiv).css({'position':'absolute','top':"-9999px",'width':'50px','height':'50px','overflow':'scroll'});this.$body.append(scrollDiv);var scrollbarWidth=scrollDiv.offsetWidth-scrollDiv.clientWidth;this.$body.get(0).removeChild(scrollDiv);return scrollbarWidth;};StoreMapHandler.prototype.adjustDialog=function(){var newPadR='';var newPadL='';var bodyCalc=false;var modalIsOverflowing=this.overlay.offsetWidth>this.overlay.clientWidth;if(this.bodyIsOverflowing&&!modalIsOverflowing){newPadR=this.scrollbarWidth;}else if(!this.bodyIsOverflowing&&modalIsOverflowing){newPadL=this.scrollbarWidth;bodyCalc=true;}
this.overlay.css({paddingRight:newPadR,paddingLeft:newPadL});if(bodyCalc){this.$body.css('background-position','calc(50% + '+this.scrollbarWidth+'px) 0');}};;