var PhoneCall={defaultPhone:'123-45-67',baseDate:new Date(),timePickersEnabled:false,isMobile:jQuery('html').hasClass('mobile-yes'),open:function(params)
{if(this.isMobile){return;}
if(params==undefined){params={};}
jQuery.modalbox({ajax:'/request.php',data:{REQUEST_ACTION:'add_phonecall_request',idSubject:params.idSubject==undefined?1:params.idSubject,idEntity:params.idEntity==undefined?0:params.idEntity,typeEntity:params.typeEntity==undefined?'':params.typeEntity},onSuccess:function(data,response){this.onAjaxSuccess(data);this.d.wrap0.removeClass('pp-window-ok').removeClass('pp-window-disb').addClass(response.className);PhoneCall.baseDate=new Date(response.baseDate*1000);}},{containerClass:'pp-window-user',offsetTop:50,insideAjaxOverlay:true,containerBlocks:['pp-window-user-i nohighlight'],containerBottomHTML:'<i class="pp-window-user-bt"></i>',position:'fixed',overlayClass:'pp-window-user-overlay',onClose:function(){},onShow:function(){PhoneCall.init();}});jQuery(document).scrollTo({top:0,left:0},0);return true;},init:function()
{if(!jQuery('#default-time-checkbox').length){this.timePickersEnabled=true;}
jQuery('#phone-body').blur(function(event){if(!jQuery(event.target).val().length){jQuery(event.target).val(PhoneCall.defaultPhone).addClass('ip-placeholder');}else{jQuery(event.target).removeClass('ip-placeholder');}}).focus(function(event){if(jQuery(event.target).val()==PhoneCall.defaultPhone){jQuery(event.target).removeClass('ip-placeholder').val('');}}).keyup(function(event){if(event.keyCode==13){if(PhoneCall.validateSubmit()){PhoneCall.disableForm();PhoneCall.performAjaxSubmit();}}});jQuery('#fullname').keyup(function(event){if(event.keyCode==13){if(PhoneCall.validateSubmit()){PhoneCall.disableForm();PhoneCall.performAjaxSubmit();}}});jQuery('#phone-code').keyup(function(event){if(event.keyCode==13){if(PhoneCall.validateSubmit()){PhoneCall.disableForm();PhoneCall.performAjaxSubmit();}}});jQuery('#subject').keyup(function(event){if(event.keyCode==13){if(PhoneCall.validateSubmit()){PhoneCall.disableForm();PhoneCall.performAjaxSubmit();}}});jQuery(document).on('change','#another-time-checkbox',function(event){PhoneCall.changeRadiobuttons();});jQuery(document).on('change','#default-time-checkbox',function(event){PhoneCall.changeRadiobuttons();});jQuery('#phonecall-close').click(function(event){event.preventDefault();jQuery.modalbox.close();});this.enableForm();jQuery('#fullname').select();},changeRadiobuttons:function()
{if(jQuery('#default-time-checkbox').length){if(jQuery('#default-time-checkbox').prop('checked')){jQuery('#time-from').prop('disabled',true).addClass('ip-disabled');jQuery('#time-to').prop('disabled',true).addClass('ip-disabled');this.timePickersEnabled=false;}else{jQuery('#time-from').prop('disabled',false).removeClass('ip-disabled');jQuery('#time-to').prop('disabled',false).removeClass('ip-disabled');this.timePickersEnabled=true;}}else{jQuery('#time-from').prop('disabled',false).removeClass('ip-disabled');jQuery('#time-to').prop('disabled',false).removeClass('ip-disabled');this.timePickersEnabled=true;}},disableForm:function()
{jQuery('#phonecall-form').find('input,select,textarea').prop('disabled',true);jQuery('#phonecall-submit').unbind('click').click(function(event){event.preventDefault();});},enableForm:function()
{jQuery('#phonecall-form').find('input,select,textarea').not('#time-from, #time-to').prop('disabled',false);jQuery('#modalbox-content #phonecall-submit').click(function(event){event.preventDefault();if(PhoneCall.validateSubmit()){PhoneCall.disableForm();PhoneCall.performAjaxSubmit();}});},disableTimePickers:function()
{jQuery('#time-from, #time-to').prop('disabled',true);},enableTimePickers:function()
{jQuery('#time-from, #time-to').prop('disabled',false);},validateSubmit:function()
{if(!jQuery('#fullname').val().length){alert('Представьтесь, пожалуйста');jQuery('#fullname').focus();return false;}
if(isNaN(parseInt(jQuery('#subject').val()))){alert('Выберите тему разговора');jQuery('#subject').focus();return false;}
if(isNaN(parseInt(jQuery('#phone-code').val()))){alert('Укажите Ваш номер телефона');return false;}
if(!jQuery('#phone-body').val().length||jQuery('#phone-body').val()==this.defaultPhone){alert('Укажите Ваш номер телефона');jQuery('#phone-body').focus();return false;}
return true;},_getTimeRange:function()
{var fromDate=this.baseDate;var toDate=new Date(this.baseDate);var curDate=new Date();if(jQuery('#default-time-checkbox').prop('checked')){fromDate=new Date();toDate=new Date();fromDate.setSeconds(fromDate.getSeconds()+10);toDate.setMinutes(toDate.getMinutes()+30);}else if(jQuery('#another-time-checkbox').prop('checked')){fromDate.setHours(jQuery('#time-from').val(),0,0);toDate.setHours(jQuery('#time-to').val(),0,0);}else{fromDate.setHours(jQuery('#time-from').val(),0,0);toDate.setHours(jQuery('#time-to').val(),0,0);}
return[Math.floor(fromDate.getTime()/1000),Math.floor(toDate.getTime()/1000)];},refresh:function()
{var isDefaultSelected=true;if(jQuery('#default-time-checkbox').length){if(jQuery('#default-time-checkbox').prop('checked')){isDefaultSelected=true;}else{isDefaultSelected=false;}}else{isDefaultSelected=false;}
var params={REQUEST_ACTION:'add_phonecall_request',fullname:jQuery('#fullname').val(),idSubject:jQuery('#subject').val(),phoneCode:jQuery('#phone-code').val(),phoneBody:jQuery('#phone-body').val(),timeFrom:jQuery('#time-from').val(),timeTo:jQuery('#time-to').val(),idEntity:jQuery('#id-entity').val(),isDefaultSelected:isDefaultSelected,typeEntity:jQuery('#type-entity').val()};jQuery.modalbox.ajax('/request.php',params,function(data,response){jQuery(jQuery.modalbox.getContent()).html(data);jQuery.modalbox.removeWrapClass(0,'pp-window-ok');jQuery.modalbox.removeWrapClass(0,'pp-window-disb');jQuery.modalbox.addWrapClass(0,response.className);PhoneCall.baseDate=new Date(response.baseDate*1000);jQuery('#fullname').val(params.fullname);jQuery('#subject').val(params.idSubject);jQuery('#phone-code').val(params.phoneCode);jQuery('#phone-body').val(params.phoneBody);jQuery('#time-from').val(params.timeFrom);jQuery('#time-to').val(params.timeTo);jQuery('#id-entity').val(params.idEntity);jQuery('#type-entity').val(params.typeEntity);if(params.isDefaultSelected){jQuery('#default-time-checkbox').prop('checked',true);jQuery('#another-time-checkbox').prop('checked',false);}else{jQuery('#default-time-checkbox').prop('checked',false);jQuery('#another-time-checkbox').prop('checked',true);}
PhoneCall.changeRadiobuttons();PhoneCall.init();},function(data,response){jQuery.modalbox.close();alert('Произошла ошибка. Попробуйте еще раз');});},performAjaxSubmit:function()
{var isDefaultTime=true;if(jQuery('#default-time-checkbox').length){if(jQuery('#default-time-checkbox').prop('checked')){isDefaultTime=true;}else{isDefaultTime=false;}}else{isDefaultTime=false;}
var params={REQUEST_ACTION:'submit_phonecall_request',fullname:jQuery('#fullname').val(),idSubject:jQuery('#subject').val(),phoneCode:jQuery('#phone-code').val(),phoneBody:jQuery('#phone-body').val(),isDefaultTime:isDefaultTime,timerange:[jQuery('#time-from').val(),jQuery('#time-to').val()],baseDate:this.baseDate.getFullYear()+'-'+(this.baseDate.getMonth()+1)+'-'+this.baseDate.getDate()+' '+this.baseDate.getHours()+':'+this.baseDate.getMinutes()+':'+this.baseDate.getSeconds(),idEntity:jQuery('#id-entity').val(),typeEntity:jQuery('#type-entity').val()};jQuery.modalbox.ajax('/request.php',params,function(data,response){PhoneCall.enableForm();if(PhoneCall.timePickersEnabled){PhoneCall.enableTimePickers();}
if(!response.result){alert(response.message);if(response.reload){PhoneCall.refresh();}}else{try{yaCounter1067243.reachGoal('phonecall_submit');}catch(e){}
try{dataLayer.push({'event':'gaEvent','eventCategory':'phonecall','eventAction':'submit'});}catch(e){}
jQuery.modalbox.impl.d.wrap0.removeClass('pp-window-disb').addClass('pp-window-ok');jQuery(jQuery.modalbox.getContent()).html('<div class="pp-window-status"></div><h2>'+response.message+'</h2><p class="pp-window-gotocart"><a id="phonecall-close" href="/" class="dashed">закрыть</a></p>');jQuery('#phonecall-close').click(function(event){event.preventDefault();jQuery.modalbox.close();});}},function(data,response){alert('Произошла ошибка. Попробуйте еще раз');PhoneCall.enableForm();if(PhoneCall.timePickersEnabled){PhoneCall.enableTimePickers();}});return;}};(function($){$(document).on('click','.phonecall',function(e){e.preventDefault();PhoneCall.open();});})(jQuery);;