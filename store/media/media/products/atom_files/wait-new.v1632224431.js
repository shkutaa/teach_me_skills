jQuery(function($){function leaveRequest()
{this.isRequestRunning=false;var self=this;this.doRequest=function(element,idGoods,onAjaxStart,callback)
{if(this.isRequestRunning){return;}
this.isRequestRunning=true;if(typeof this[onAjaxStart]==="function"){this[onAjaxStart](idGoods,element);}
$.ajax({url:"/goods/ajax/leave-request.php",data:{idGoods:idGoods},dataType:'json',success:function(response){if(typeof self[callback]==="function"){self[callback](response,idGoods,element);}},error:function(response){alert('Произошла ошибка. Попробуйте повторить действие позже');}}).always(function(){self.isRequestRunning=false;});}
this.onListingGrid=function(idGoods,element)
{$(element).closest('.item-type-card__btn').addClass('item-type-card__btn--loader');}
this.cbListingGrid=function(response,idGoods,element)
{var span=$(element).closest('.item-type-card__btn');$(span).removeClass('item-type-card__btn--loader');if(response.error){alert(response.message);}else{if(response.action=='add'){$(span).closest('a').attr('href','/personal/wait.phtml?id_element='+idGoods+'#e'+idGoods).addClass('item-type-card__cost__link--active');$(element).text('Заявка принята');$(span).find('.item-type-card__btn__ico--time').removeClass('item-type-card__btn__ico--time').addClass('item-type-card__btn__ico--check');}else if(response.action=='delete'){$(span).closest('a').attr('href','/personal/wait.phtml?act=addWaitPersonal&id_element='+idGoods+'&id_wait='+response.idWait+'#'+idGoods).removeClass('item-type-card__cost__link--active');$(element).text('Оставить заявку');$(span).find('.item-type-card__btn__ico--check').removeClass('item-type-card__btn__ico--check').addClass('item-type-card__btn__ico--time');}}}
this.onListingList=function(idGoods,element)
{$(element).prop('disabled',true).addClass('button-ntp_disabled').find('i').removeClass('button-ntp__ico_chk1').addClass('button-ntp__ico_loader');}
this.cbListingList=function(response,idGoods,element)
{$(element).removeProp('disabled').removeClass('button-ntp_disabled').find('i').removeClass('button-ntp__ico_loader');if(response.error){alert(response.message);}else{if(response.action=='add'){$(element).addClass('button-ntp_m3').find('i').removeClass('button-ntp__ico_time').addClass('button-ntp__ico_chk1');$(element).find('.button-ntp__span').text('Заявка принята');var form=$(element).closest('form');$(form).find('input[name="act"]').remove();}else if(response.action=='delete'){$(element).removeClass('button-ntp_m3').find('i').addClass('button-ntp__ico_time').removeClass('button-ntp__ico_chk1');$(element).find('.button-ntp__span').text('Оставить заявку');var form=$(element).closest('form');$(form).append('<input type="hidden" name="act" value="addWaitPersonal" />');}}}
this.onGoodsMore=function(idGoods,element)
{$('.addrequest-btn').addClass('i-button_processing');}
this.cbGoodsMore=function(response,idGoods,element)
{if(response.error){$('.addrequest-btn').removeClass('i-button_processing');}else{$('.addrequest-btn').addClass('b-product-control__button_hidden');var link=$('.gotorequest-btn');if($(link).length&&$(link).hasClass('b-product-control__button_hidden')){$(link).removeClass('b-product-control__button_hidden')}}
this.cbListingList(response,idGoods,element);}
this.onGoodsBlock=function(idGoods,element)
{return;}
this.cbGoodsBlock=function(error,message,idGoods,element)
{return;}}
var leaveRequest=new leaveRequest();var $document=$(document);var $html=$document.find('html, body');var $first=$('.first-button.leave-request');var stopEventsClass='stop-events';var popoverVisibleClass='action-popover_visible';var popoverProcessingClass='action-popover_processing';var clickListener;$(document).on('click','.leave-request',function(event){var $this=$(this);event.preventDefault();if($this.hasClass('first-button')){var $actionPopover=$this.parent().parent().find('.action-popover');if($actionPopover.length){if(isMobile){$html.addClass(stopEventsClass);}
$first.addClass('i-button_focus');$actionPopover.addClass(popoverVisibleClass);setTimeout(function(){$actionPopover.find('.i-popup__input').focus();},100);$document.on('click',clickListener=function(event){if(!$(event.target).parents('.b-product-control__btn-container').length){if(isMobile){$html.removeClass(stopEventsClass);}
$first.removeClass('i-button_focus');close($actionPopover,popoverVisibleClass);}});return;}}
processRequest($this);});$document.on('click','.action-popover__submit',function(e){var $this=$(this);var $curActionPopover=$this.parents('.action-popover');var $iPopoverWarning=$curActionPopover.find('.i-popover_warning');var $iPopoverWarningText=$iPopoverWarning.find('.i-popover__line');var $emailInput=$curActionPopover.find('.i-popup__input');e.preventDefault();$.ajax({url:'/client/set_email.php',type:'post',data:{email:$emailInput.val()},beforeSend:function(){$first.addClass('i-button_processing');$curActionPopover.addClass(popoverProcessingClass);$iPopoverWarning.removeClass('i-popover_visible');$iPopoverWarningText.html('');},complete:function(){$first.removeClass('i-button_processing');$curActionPopover.removeClass(popoverProcessingClass);},success:function(data){if(data.error){$iPopoverWarningText.html(data.text);$iPopoverWarning.addClass('i-popover_visible');$emailInput.focus();}else{close($curActionPopover,popoverVisibleClass);processRequest($first);}}});});$document.on('keyup','.i-popup__input',function(){var $this=$(this);var $popoverParent=$this.parents('.action-popover');var $popoverSubmit=$popoverParent.find('.action-popover__submit');if($this.val().length!==0){$popoverSubmit.removeClass('i-button_disabled');}else{$popoverSubmit.addClass('i-button_disabled');}});function close(dropdown,visibleClass){dropdown.removeClass(visibleClass);dropdown.find('.i-popover_warning').removeClass('i-popover_visible');dropdown.find('.i-popup__input').val('');dropdown.find('.action-popover__submit').addClass('i-button_disabled');$document.off('click',clickListener);}
function processRequest($this){var id=parseInt($this.data('id'));var callback=$this.data('callback');var onAjaxStart=$this.data('onajaxstart');if(!isNaN(id)&&(id>0)){leaveRequest.doRequest($this,id,onAjaxStart,callback);}}});;